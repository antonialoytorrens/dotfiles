#!/usr/bin/env python3
import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, Gdk
import os

# Configuration
ButtonWidth = 200
ButtonHeight = 80
IconSize = 48
IconTheme = Gtk.IconTheme.get_default()

# Theme location (fallback to standard if Papirus isn't found)
ICON_PATH = "/usr/share/icons/Papirus-Dark"

class ExitWindow(Gtk.Window):
    def __init__(self):
        Gtk.Window.__init__(self, title="Exit Session")
        self.set_border_width(10)
        self.set_position(Gtk.WindowPosition.CENTER_ALWAYS)
        self.set_keep_above(True)
        self.stick()
        self.connect("key-press-event", self.on_key_press)
        self.connect("delete-event", Gtk.main_quit)

        # Main layout
        self.grid = Gtk.Grid()
        self.grid.set_column_spacing(10)
        self.grid.set_row_spacing(10)
        self.add(self.grid)

        # Build buttons: (IconName, Label, Command, Column, Row)
        buttons = [
            ("system-lock-screen", "_Lock Screen", "xscreensaver-command -lock", 0, 0),
            ("system-reboot", "_Restart IceWM", "icesh restart", 1, 0),
            ("system-log-out", "_Log Out", "loginctl terminate-session self", 0, 1),
            ("system-suspend", "_Suspend", "systemctl suspend", 1, 1),
            ("system-reboot", "_Reboot", "systemctl reboot", 0, 2),
            ("system-shutdown", "_Shutdown", "systemctl poweroff", 1, 2),
        ]

        for icon, label, cmd, col, row in buttons:
            self.add_button(icon, label, cmd, col, row)

        self.show_all()

    def add_button(self, icon_name, label_text, command, col, row):
        button = Gtk.Button.new_with_mnemonic(label_text)
        button.set_size_request(ButtonWidth, ButtonHeight)
        
        # Icon logic
        pixbuf = self.get_icon_pixbuf(icon_name)
        if pixbuf:
            image = Gtk.Image.new_from_pixbuf(pixbuf)
            button.set_image(image)
            button.set_image_position(Gtk.PositionType.TOP)
            button.set_always_show_image(True)

        button.connect("clicked", self.on_button_clicked, command)
        self.grid.attach(button, col, row, 1, 1)

    def get_icon_pixbuf(self, name):
        try:
            # Try to load from theme
            icon_info = IconTheme.lookup_icon(name, IconSize, 0)
            if icon_info:
                return icon_info.load_icon()
        except:
            pass
        return None

    def on_button_clicked(self, widget, command):
        os.system(command)
        Gtk.main_quit()

    def on_key_press(self, widget, event):
        if event.keyval == Gdk.KEY_Escape:
            Gtk.main_quit()

if __name__ == "__main__":
    app = ExitWindow()
    Gtk.main()
